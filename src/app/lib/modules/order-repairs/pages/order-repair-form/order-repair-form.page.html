<app-main-header-layout></app-main-header-layout>
<app-header-page [title]="titleHeader" [showBackButton]="true"></app-header-page>
<ion-content class="ion-padding">

  <form [formGroup]="form" (submit)="onSubmit()">

    <ion-grid>

      <!--
        CUSTOMERS SECTION
      -->
      <ion-row>

        <ion-col size="12" sizeSm="12" sizeMd="4">

          <ion-list lines="none">

            <ion-item>
              <ion-label>
                <h2>No. Orden</h2>
                <p>{{ orderRepair ? orderRepair.orderId : '-' }}</p>
                <h2>Fecha</h2>
                <p>{{ (orderRepair ? orderRepair.createdAt : currentDate) | date:'short' }}</p>
                <ng-container *ngIf="orderRepair">
                  <h2>Creado por</h2>
                  <p>{{ orderRepair.createdBy?.name }} {{ orderRepair.createdBy?.lastName }}</p>
                  <h2>Fecha estimada entrega</h2>
                  <p>{{ orderRepair.deliveryDate | date:'short' }}</p>
                  <h2>Pagado</h2>
                  <p>{{ orderRepair.isPaid ? 'Si' : 'No' }}</p>
                  <h2>Estatus</h2>
                  <p>{{ orderRepair.status }}</p>
                </ng-container>
              </ion-label>
            </ion-item>

          </ion-list>

        </ion-col>

        <ion-col size="12" sizeSm="12" sizeMd="8">

          <div class="col-header">

            <ion-text>
              <h6>Cliente</h6>
            </ion-text>

            <div *ngIf="!isView && !isEdit">
              <ion-button fill="clear" color="primary" (click)="onSearchCustomer()">
                <ion-icon slot="icon-only" name="search-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="primary" (click)="onCreateCustomer()">
                <ion-icon slot="icon-only" name="add-outline"></ion-icon>
              </ion-button>
            </div>

          </div>

          <ion-list lines="full">

            <ion-item>
              <ion-icon name="people" slot="start"></ion-icon>
              <ion-label>
                <h2 *ngIf="!customerSelected">No se ha seleccionado un cliente</h2>
                <ng-container *ngIf="customerSelected">
                  <h2>{{ customerSelected.getFullName() }}</h2>
                  <p>{{ customerSelected.getPhoneFormat() }}</p>
                  <p *ngIf="customerSelected.email">{{ customerSelected.email }}</p>
                </ng-container>
              </ion-label>
            </ion-item>

          </ion-list>

        </ion-col>

      </ion-row>

      <ion-row>

        <!--
          WORKS SECTION
        -->
        <ion-col size="12" sizeSm="12" sizeMd="6">

          <div class="col-header">

            <ion-text>
              <h6>Servicios</h6>
            </ion-text>

            <div *ngIf="!isView">
              <ion-button fill="clear" color="primary" (click)="onSearchWork()">
                <ion-icon slot="icon-only" name="search-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="primary" (click)="onCreateWork()">

                <ion-icon slot="icon-only" name="add-outline"></ion-icon>
              </ion-button>
            </div>

          </div>

          <ng-container formArrayName="works">

            <ion-list lines="full">

              <ion-item *ngIf="!works.controls.length">
                <ion-icon name="hammer" slot="start"></ion-icon>
                <ion-label>
                  <h2>No ha agregado un servicio</h2>
                </ion-label>
              </ion-item>

              <ng-container *ngFor="let workForm of works.controls; let indexWork = index">

                <ng-container [formGroupName]="indexWork">

                  <ion-item color="dark">
                    <ion-icon name="hammer" slot="start"></ion-icon>
                    <ion-label>
                      <h2>{{ workForm.get('name').value }}</h2>
                    </ion-label>
                    <ion-button color="danger" fill="clear" slot="end"
                                (click)="works.removeAt(indexWork); onCalculateAmount();" *ngIf="!isView">
                      <ion-icon slot="icon-only" name="trash"></ion-icon>
                    </ion-button>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">Monto*</ion-label>
                    <ion-input placeholder="Monto" enterkeyhint="next" inputmode="decimal" type="number"
                               class="ion-text-right" formControlName="amount" required [readonly]="isView"
                               (ngModelChange)="onCalculateAmount()" [debounce]="500">
                    </ion-input>
                  </ion-item>
                  <ion-item class="ion-margin-bottom">
                    <ion-label position="stacked">Nota</ion-label>
                    <ion-textarea rows="1" color="medium" placeholder="Agregar una nota..." formControlName="notes"
                                  [readonly]="isView">
                    </ion-textarea>
                  </ion-item>

                </ng-container>

              </ng-container>

            </ion-list>

          </ng-container>

        </ion-col>

        <!--
          CHARGES SECTION
        -->
        <ion-col size="12" sizeSm="12" sizeMd="6">

          <div class="col-header">

            <ion-text>
              <h6>Cargos</h6>
            </ion-text>

            <div *ngIf="!isView">
              <ion-button fill="clear" color="primary" (click)="onSearchCharge()">
                <ion-icon slot="icon-only" name="search-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="primary" (click)="onCreateCharge()">
                <ion-icon slot="icon-only" name="add-outline"></ion-icon>
              </ion-button>
            </div>

          </div>

          <ng-container formArrayName="charges">

            <ion-list lines="full">

              <ion-item *ngIf="!charges.controls.length">
                <ion-icon name="cash" slot="start"></ion-icon>
                <ion-label>
                  <h2>No ha agregado un cargo</h2>
                </ion-label>
              </ion-item>

              <ng-container *ngFor="let chargeForm of charges.controls; let indexCharge = index">

                <ng-container [formGroupName]="indexCharge">

                  <ion-item color="dark">
                    <ion-icon name="cash" slot="start"></ion-icon>
                    <ion-label>
                      <h2>{{ chargeForm.get('name').value }}</h2>
                    </ion-label>
                    <ion-button color="danger" fill="clear" slot="end"
                                (click)="charges.removeAt(indexCharge); onCalculateAmount();" *ngIf="!isView">
                      <ion-icon slot="icon-only" name="trash"></ion-icon>
                    </ion-button>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">Monto*</ion-label>
                    <ion-input placeholder="Monto" enterkeyhint="next" inputmode="decimal" type="number"
                               class="ion-text-right" formControlName="amount" required [readonly]="isView"
                               (ngModelChange)="onCalculateAmount()" [debounce]="500">
                    </ion-input>
                  </ion-item>
                  <ion-item class="ion-margin-bottom">
                    <ion-label position="stacked">Nota</ion-label>
                    <ion-textarea rows="1" color="medium" placeholder="Agregar una nota..." formControlName="notes"
                                  [readonly]="isView">
                    </ion-textarea>
                  </ion-item>

                </ng-container>

              </ng-container>

            </ion-list>

          </ng-container>

        </ion-col>

      </ion-row>

      <!--
        DEVICES SECTION
       -->
      <ion-row>

        <ion-col size="12">

          <div class="col-header">

            <ion-text>
              <h6>Dispositivos</h6>
            </ion-text>

            <div *ngIf="!isView">
              <ion-button fill="clear" color="primary" (click)="onAddDevice()">
                <ion-icon slot="icon-only" name="add-outline"></ion-icon>
              </ion-button>
            </div>

          </div>

          <ion-list lines="full">

            <ion-item *ngIf="!devices.length">
              <ion-icon name="desktop" slot="start"></ion-icon>
              <ion-label>
                <h2>No ha agregado un dispositivo</h2>
              </ion-label>
            </ion-item>

            <ng-container *ngFor="let deviceOrderRepair of devices; let indexDevice = index">

              <ion-item color="dark">
                <ion-icon name="desktop" slot="start"></ion-icon>
                <ion-label>
                  <h2>{{ deviceOrderRepair.device.name }}</h2>
                  <h3>
                    {{ deviceOrderRepair.brand.name }}
                    {{ deviceOrderRepair.model ? ' >> ' + deviceOrderRepair.model : ''}}
                  </h3>
                </ion-label>
                <ion-button color="danger" fill="clear" slot="end" (click)="devices.splice(indexDevice, 1)"
                            *ngIf="!isView">
                  <ion-icon slot="icon-only" name="trash"></ion-icon>
                </ion-button>
              </ion-item>

              <ion-row>

                <ion-col size="12" sizeSm="12" sizeMd="6">
                  <ion-item lines="none">
                    <ion-label>
                      <h3>¿Escendido?</h3>
                      <p>{{ deviceOrderRepair.itsOn ? 'Si' : 'No' }}</p>
                      <h3>Tarjeta</h3>
                      <p>{{ deviceOrderRepair.cards }}</p>
                      <h3>Accesorios</h3>
                      <p class="ion-text-wrap">{{ deviceOrderRepair.accessory }}</p>
                      <h3>Contraseña</h3>
                      <p class="ion-text-wrap">{{ deviceOrderRepair.password ?? '-Sin contraseña-' }}</p>
                    </ion-label>
                  </ion-item>
                </ion-col>

                <ion-col size="12" sizeSm="12" sizeMd="6">
                  <ion-item lines="none">
                    <ion-label>
                      <h3>Detalle</h3>
                      <p class="ion-text-wrap">{{ deviceOrderRepair.details }}</p>
                      <h3>Reporto cliente</h3>
                      <p class="ion-text-wrap">{{ deviceOrderRepair.customerReport }}</p>
                      <ng-container *ngIf="orderRepair">
                        <!-- <h3>Diagnostico</h3>
                        <p class="ion-text-wrap">{{ deviceOrderRepair.finalDiagnosis }}</p> -->
                        <!-- <h3>Garantía</h3>
                        <p>{{ deviceOrderRepair.warrantyDays ? deviceOrderRepair.warrantyDays : '-Sin garantía-' }}</p> -->
                        <h3>Estatus</h3>
                        <p>{{ deviceOrderRepair.status }}</p>
                      </ng-container>
                    </ion-label>
                  </ion-item>
                </ion-col>

              </ion-row>

            </ng-container>

          </ion-list>

        </ion-col>

      </ion-row>

      <!--
        TOTALS SECTION
      -->
      <ion-row>
        <ion-col size="12">
          <ion-list>
            <ion-item>
              <ion-label slot="end" class="ion-text-end">
                <h3>Importe</h3>
                <p>{{ form.get('totalAmount').value | currency:'MXN' }}</p>
                <h3>Anticipo</h3>
                <p>{{ form.get('advanceAmount').value | currency:'MXN' }}</p>
                <h3>Resta</h3>
                <p>{{ form.get('remainingAmount').value | currency:'MXN' }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-col>
      </ion-row>


      <!--
        CONFIRM BUTTONS SECTION
      -->
      <app-confirm-cancel-buttons-form *ngIf="!isView" [isSend]="isSend"></app-confirm-cancel-buttons-form>

    </ion-grid>

  </form>

</ion-content>
